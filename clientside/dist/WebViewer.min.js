/*!
 * RCRS Web Viewer v0.1.0
 * https://github.com/roborescue/rcrs-web-viewer
 * 
 * Released under the BSD-3-Clause license
 * https://opensource.org/licenses/BSD-3-Clause
 *
 * Date: 2020-09-03T10:41:27.343Z (Thu, 03 Sep 2020 10:41:27 GMT)
 */
const DRAW_BORDER_LINE=!0,DRAW_BORDER_LINE_WIDTH=50,ENTITY_NAME_CIVILIAN="Civilian",ENTITY_NAME_AMBULANCE_TEAM="Ambulance team",ENTITY_NAME_FIRE_BRIGADE="Fire brigade",ENTITY_NAME_POLICE_FORCE="Police force",ENTITY_NAME_BLOCKADE="Blockade",ENTITY_NAME_HYDRANT="Hydrant",ENTITY_NAME_ROAD="Road",ENTITY_NAME_REFUGE="Refuge",ENTITY_NAME_BUILDING="Building",ENTITY_NAME_GAS_STATION="Gas Station",ENTITY_NAME_AMBULANCE_CENTRE="Ambulance centre",ENTITY_NAME_FIRE_STATION="Fire station",ENTITY_NAME_POLICE_OFFICE="Police office",ENTITY_ATTR_ID="Id",ENTITY_ATTR_ENTITY_NAME="EntityName",ENTITY_ATTR_HP="HP",ENTITY_ATTR_FIERYNESS="Fieryness",ENTITY_ATTR_APEXES="Apexes",ENTITY_ATTR_POSITION="Pos",ICONS_POLICE_OFFICE="image/po.png",ICONS_AMBULANCE_CENTRE="image/ac.png",ICONS_FIRE_STATION="image/fs.png",ICONS_REFUGE="image/rf.png",ICONS_GAS_STATION="image/gs.png",ICONS_HYDRANT="image/hy.png",SETTING_ICON_RADIUS=7e3,WORKER_COMMAND_LOADDATA="load_data",WORKER_COMMAND_PROGRESSREPORT="progress_report",WORKER_COMMAND_MAPBOUNDS="map_bounds",WORKER_COMMAND_CYCLEDATA="cycle_data",WORKER_COMMAND_INFO="info",WORKER_COMMAND_BASEDATA="base_data",HUMAN_HP_MAX=1e4,HUMAN_HP_INJURED=7500,HUMAN_HP_CRITICAL=1e3,COLOR_HUMAN_TYPE_CIVILIAN=[0,1,0],COLOR_HUMAN_TYPE_FIRE_BRIGADE=[1,0,0],COLOR_HUMAN_TYPE_AMBULANCE_TEAM=[1,1,1],COLOR_HUMAN_TYPE_POLICE_FORCE=[0,0,1],COLOR_HUMAN_TYPE_DEAD=[0,0,0],COLOR_ROAD_DEFAULT=[.72,.72,.72],COLOR_BLOCKADE_DEFAULT=[0,0,0],COLOR_BORDER_DEFAULT=[0,0,0],COLOR_BUILDING_FIERYNESS_UNBURNT=[.52,.52,.52],COLOR_BUILDING_FIERYNESS_HEATING=[.69,.69,.21],COLOR_BUILDING_FIERYNESS_BURNING=[.8,.47,.19],COLOR_BUILDING_FIERYNESS_INFERNO=[.62,.2,.2],COLOR_BUILDING_FIERYNESS_WATER_DAMAGE=[.19,.47,.51],COLOR_BUILDING_FIERYNESS_MINOR_DAMAGE=[.39,.54,.82],COLOR_BUILDING_FIERYNESS_MODERATE_DAMAGE=[.39,.27,.74],COLOR_BUILDING_FIERYNESS_SEVERE_DAMAGE=[.31,.23,.54],COLOR_BUILDING_FIERYNESS_BURNT_OUT=[0,0,0];function GameMaker(e,t=(()=>{})){this.histories=[],this.currentCycle=0,this.lastLoadedCycle=-1,this.baseHistorian=new Historian,this.setBaseHistorian=function(e){this.baseHistorian=e},this.drawCycle=function(e=this.currentCycle){this.canvasDrawer.drawer.historyManager.historians=[this.baseHistorian,this.histories[e]],this.canvasDrawer.drawer.redraw()},this.getLastCycleNumber=function(){return this.getInfo().lastCycle},this.getLastLoadedCycleNumber=function(){return this.lastLoadedCycle},this.setCorrectScaleAndTranslation=function(e,t,a,s){let i=Math.abs(a-e),n=Math.abs(s-t),o=this.canvasDrawer.drawer.gl.canvas,r=o.width,l=o.height,c=r/i,d=l/n,_=c<d?c:d;_*=.9,this.canvasDrawer.drawer.setScale(_),this.canvasDrawer.drawer.setTextureScale(_);let h=(r-_*i)/2,E=(l-_*n)/2;this.canvasDrawer.drawer.setTextureTranslation(h,E+n*_),this.canvasDrawer.drawer.updateTranslation(h,E+n*_)},this.loadCycle=function(e,t){this.histories[e]=t,e>this.lastLoadedCycle&&(this.lastLoadedCycle=e)},this.getInfo=function(){return this.infoObject},this.setInfo=function(e){this.infoObject=e,this.allCycles=e.lastCycle},this.constructor=function(e,t){this.canvasDrawer=e,this.allCycles=0,this.infoObject={},this.positionMaker=new PositionMaker,this.canvasDrawer.drawer.enableBlending(),t("Loading game entities ...",90,!1)},this.constructor(e,t)}function UIController(e){this.loadDataFromInfo=function(e,t){return e in this.info?this.info[e]:t},this.start=function(){!1===this.isPlaying&&(this.isPlaying=setInterval(()=>{this.nextCycle()||this.pause()},this.playingDelay),this.reloadControllPanel())},this.pause=function(){!1!==this.isPlaying&&clearInterval(this.isPlaying),this.isPlaying=!1,this.reloadControllPanel()},this.reset=function(){this.pause(),this.setCycle(0)},this.setLoadedCycle=function(e){this.lastLoadedCycle<e&&(this.lastLoadedCycle=e,this.reloadControllPanel())},this.reloadControllPanel=function(){!1!==this.isPlaying||this.currentCycle>=this.lastLoadedCycle?this.buttons.start.prop("disabled",!0):this.buttons.start.prop("disabled",!1),0==this.currentCycle?this.buttons.back.prop("disabled",!0):this.buttons.back.prop("disabled",!1),this.currentCycle>=this.lastLoadedCycle?this.buttons.next.prop("disabled",!0):this.buttons.next.prop("disabled",!1)},this.setCycle=function(e){$("#cycle-number").html(e+" / "+this.lastCycle),this.currentCycle=e,this.showCycle(e),this.reloadControllPanel()},this.nextCycle=function(){return!(this.currentCycle>=this.lastLoadedCycle)&&(this.setCycle(this.currentCycle+1),!0)},this.prevCycle=function(){return!(this.currentCycle<=0)&&(this.setCycle(this.currentCycle-1),!0)},this.buttons={next:$("#controll-next"),back:$("#controll-back"),start:$("#controll-start"),pause:$("#controll-pause"),reset:$("#controll-reset")},this.info=e,this.currentCycle=0,this.isPlaying=!1,this.lastLoadedCycle=-1,this.getScore=this.loadDataFromInfo("getScore",e=>-1),this.showCycle=this.loadDataFromInfo("showCycle",e=>{}),this.lastCycle=this.loadDataFromInfo("lastCycle",0),this.playingDelay=this.loadDataFromInfo("playingDelay",1500);let t=this.loadDataFromInfo("teamName","Unknown"),a=this.loadDataFromInfo("mapName","Unknown");$("#team-name-field").html(t),$("#map-name-field").html(a),this.buttons.next.click(()=>{uiController.nextCycle()}),this.buttons.back.click(()=>{uiController.prevCycle()}),this.buttons.start.click(()=>{uiController.start()}),this.buttons.pause.click(()=>{uiController.pause()}),this.buttons.reset.click(()=>{uiController.reset()})}var gameMaker,uiController,canvasDrawer,worker;function resizeCanvasToFit(){let e=document.getElementById(CANVAS_ID);e.width=e.clientWidth,e.height=e.clientHeight}function showError(e){$(".modal").not(ERROR_MODAL).modal("hide");let t="<li>"+e+"</li>";$("#error-message").append(t),$(ERROR_MODAL).modal("show")}function showLoadingModal(){$(ERROR_MODAL).data()["bs.modal"]&&$(ERROR_MODAL).data()["bs.modal"]._isShown||$(LOADING_MODAL).modal("show")}function UISetup(e){let t=e.getInfo();uiController=new UIController({teamName:t.TeamName,mapName:t.MapName,showCycle:t=>{e.drawCycle(t)},lastCycle:e.getLastCycleNumber(),playingDelay:PLAYING_DELAY})}function setProgressBarSize(e,t=100){let a=100*e/t;$(".progress-bar").css("width",a+"%").attr("aria-valuenow",a)}function loadFunction(e,t=-1,a=!1){console.log(e),document.getElementById("status").innerText=e,t>0&&setProgressBarSize(t),a&&($(LOADING_MODAL).modal("hide"),setTimeout((function(){$(LOADING_MODAL).modal("hide")}),1e3))}function workerMassageParser(e){switch(e.data.command){case"progress_report":loadFunction(e.data.text,e.data.percent);break;case"map_bounds":gameMaker.setCorrectScaleAndTranslation(e.data.minX,e.data.minY,e.data.maxX,e.data.maxY);break;case"base_data":let t=new Historian;t.memo=e.data.data.memo,t.keys=e.data.data.keys,gameMaker.setBaseHistorian(t);break;case"cycle_data":let a=new Historian;a.memo=e.data.data.memo,a.keys=e.data.data.keys;let s=e.data.cycle;gameMaker.loadCycle(s,a),uiController.setLoadedCycle(s),0==s&&uiController.setCycle(0),2==s&&loadFunction("Completed.",100,!0);break;case"info":gameMaker.setInfo(e.data.info),UISetup(gameMaker)}}function parseShowJLOGFile(e){loadFunction("Map file downloaded ...",80),e=(e=(e=e.split("\n")).filter(e=>e.trim().length>0)).map(e=>JSON.parse(e)),loadFunction("Map file loaded ...",82);let t=["image/po.png","image/ac.png","image/fs.png",ICONS_REFUGE,"image/gs.png",ICONS_HYDRANT];canvasDrawer.loadTextures(t,t=>{loadFunction("Texture files loaded ...",90),gameMaker=new GameMaker(canvasDrawer,loadFunction),worker.postMessage({command:"load_data",data:e,textures:t})})}function main(){resizeCanvasToFit(),window.Worker?(showLoadingModal(),canvasDrawer=new CanvasDrawer({id:CANVAS_ID,errorFunction:()=>showError("WebGL is not supported."),cartographer:!0,zoominrate:1.15,zoomoutrate:.85}),window.onresize=function(){resizeCanvasToFit(),canvasDrawer.drawer.refitWebglToCanvas()},(worker=new Worker(WORKER_FILE)).onmessage=workerMassageParser,loadFunction("Downloading cycles data ...",0),$.ajax(JLOG_FILE,{progress:function(e){if(e.lengthComputable){let t=Math.round(80*e.loaded/e.total);loadFunction("Downloading cycles data ... ("+t+"%)",t)}}}).done(e=>{parseShowJLOGFile(e)})):showError("WebWorker is not supported.")}