/*!
 * RCRS Web Viewer v0.1.0
 * https://github.com/roborescue/rcrs-web-viewer
 * 
 * Released under the BSD-3-Clause license
 * https://opensource.org/licenses/BSD-3-Clause
 *
 * Date: 2020-09-01T15:36:19.543Z (Tue, 01 Sep 2020 15:36:19 GMT)
 */
const ENTITY_NAME_CIVILIAN="Civilian",ENTITY_NAME_AMBULANCE_TEAM="Ambulance team",ENTITY_NAME_FIRE_BRIGADE="Fire brigade",ENTITY_NAME_POLICE_FORCE="Police force",ENTITY_NAME_BLOCKADE="Blockade",ENTITY_NAME_HYDRANT="Hydrant",ENTITY_NAME_ROAD="Road",ENTITY_NAME_REFUGE="Refuge",ENTITY_NAME_BUILDING="Building",ENTITY_NAME_GAS_STATION="Gas Station",ENTITY_NAME_AMBULANCE_CENTRE="Ambulance centre",ENTITY_NAME_FIRE_STATION="Fire station",ENTITY_NAME_POLICE_OFFICE="Police office",ENTITY_ATTR_ID="Id",ENTITY_ATTR_ENTITY_NAME="EntityName",ENTITY_ATTR_HP="HP",ENTITY_ATTR_FIERYNESS="Fieryness",ENTITY_ATTR_APEXES="Apexes",ENTITY_ATTR_POSITION="Pos",ICONS_POLICE_OFFICE="image/po.png",ICONS_AMBULANCE_CENTRE="image/ac.png",ICONS_FIRE_STATION="image/fs.png",ICONS_REFUGE="image/rf.png",ICONS_GAS_STATION="image/gs.png",ICONS_HYDRANT="image/hy.png",SETTING_ICON_RADIUS=7e3,WORKER_COMMAND_LOADDATA="load_data",WORKER_COMMAND_PROGRESSREPORT="progress_report",WORKER_COMMAND_MAPBOUNDS="map_bounds",WORKER_COMMAND_CYCLEDATA="cycle_data",WORKER_COMMAND_INFO="info",HUMAN_HP_MAX=1e4,HUMAN_HP_INJURED=7500,HUMAN_HP_CRITICAL=1e3,COLOR_HUMAN_TYPE_CIVILIAN=[0,1,0],COLOR_HUMAN_TYPE_FIRE_BRIGADE=[1,0,0],COLOR_HUMAN_TYPE_AMBULANCE_TEAM=[1,1,1],COLOR_HUMAN_TYPE_POLICE_FORCE=[0,0,1],COLOR_HUMAN_TYPE_DEAD=[0,0,0],COLOR_ROAD_DEFAULT=[.72,.72,.72],COLOR_BLOCKADE_DEFAULT=[0,0,0],COLOR_BUILDING_FIERYNESS_UNBURNT=[.52,.52,.52],COLOR_BUILDING_FIERYNESS_HEATING=[.69,.69,.21],COLOR_BUILDING_FIERYNESS_BURNING=[.8,.47,.19],COLOR_BUILDING_FIERYNESS_INFERNO=[.62,.2,.2],COLOR_BUILDING_FIERYNESS_WATER_DAMAGE=[.19,.47,.51],COLOR_BUILDING_FIERYNESS_MINOR_DAMAGE=[.39,.54,.82],COLOR_BUILDING_FIERYNESS_MODERATE_DAMAGE=[.39,.27,.74],COLOR_BUILDING_FIERYNESS_SEVERE_DAMAGE=[.31,.23,.54],COLOR_BUILDING_FIERYNESS_BURNT_OUT=[0,0,0];function Entity(t){Object.assign(this,t),"Id"in t&&(this.Id=parseInt(t.Id)),"EntityName"in t&&(this.EntityName=t.EntityName.trim()),"HP"in t&&(this.HP=parseInt(t.HP)),"Fieryness"in t&&(this.Fieryness=parseInt(t.Fieryness))}EntityColor={},EntityColor.getDarker=function(t){return[t[0]/2,t[1]/2,t[2]/2]},EntityColor.getBuildingColor=function(t){switch(t){case 0:return COLOR_BUILDING_FIERYNESS_UNBURNT;case 1:return COLOR_BUILDING_FIERYNESS_HEATING;case 2:return COLOR_BUILDING_FIERYNESS_BURNING;case 3:return COLOR_BUILDING_FIERYNESS_INFERNO;case 4:return COLOR_BUILDING_FIERYNESS_WATER_DAMAGE;case 5:return COLOR_BUILDING_FIERYNESS_MINOR_DAMAGE;case 6:return COLOR_BUILDING_FIERYNESS_MODERATE_DAMAGE;case 7:return COLOR_BUILDING_FIERYNESS_SEVERE_DAMAGE;case 8:return COLOR_BUILDING_FIERYNESS_BURNT_OUT}return COLOR_BUILDING_FIERYNESS_UNBURNT},EntityColor.getHumanColor=function(t,e){if(0==e)return COLOR_HUMAN_TYPE_DEAD;let i;switch(t){case"Civilian":i=COLOR_HUMAN_TYPE_CIVILIAN;break;case"Fire brigade":i=COLOR_HUMAN_TYPE_FIRE_BRIGADE;break;case"Ambulance team":i=COLOR_HUMAN_TYPE_AMBULANCE_TEAM;break;case"Police force":i=COLOR_HUMAN_TYPE_POLICE_FORCE}return e<1e3&&(i=this.getDarker(i)),e<7500&&(i=this.getDarker(i)),e<1e4&&(i=this.getDarker(i)),i},EntityColor.getColor=function(t){return EntityHandler.isRoad(t)?COLOR_ROAD_DEFAULT:EntityHandler.isBuilding(t)?this.getBuildingColor(t.Fieryness):EntityHandler.isBlockade(t)?COLOR_BLOCKADE_DEFAULT:EntityHandler.isHuman(t)?this.getHumanColor(EntityHandler.getType(t),EntityHandler.getHP(t)):[0,0,0]};var EntityHandler={};function mirrorYs(t){return t.map((t,e)=>t*(e%2==1?-1:1))}function WorkerDataLoader(t,e=(()=>{})){this.getCycleObject=function(t){return this.cycles[t]},this.getCyclesNumber=function(){return this.cycles.length},this.releaseCycleMemory=function(t){delete this.cycles[t]},this.getInfoObject=function(){return this.info},this.checkForIcon=function(t){EntityHandler.getIcon(t)&&this.entitiesWithIcon.push(t)},this.createBaseCycle=function(t,e){this.minX=Number.MAX_SAFE_INTEGER,this.minY=Number.MAX_SAFE_INTEGER,this.maxX=Number.MIN_SAFE_INTEGER,this.maxY=Number.MIN_SAFE_INTEGER,t[0].Info.lastCycle=t.length-1,postInfo(t[0].Info);let i=t[0],n={all:{},building:{},road:{},blockade:{},human:{}};for(let t=0;t<i.Entities.length;t++){let e=new Entity(i.Entities[t]);this.checkForIcon(e);let s=EntityHandler.getId(e);if(n.all[s]=e,EntityHandler.isHuman(e)?n.human[s]=e:EntityHandler.isBlockade(e)?n.blockade[s]=e:EntityHandler.isRoad(e)?n.road[s]=e:n.building[s]=e,EntityHandler.isSurface(e)){let t=EntityHandler.getVertices(e);for(let e=0;e<t.length;e+=2){let i=t[e],n=t[e+1];i<this.minX&&(this.minX=i),n<this.minY&&(this.minY=n),i>this.maxX&&(this.maxX=i),n>this.maxY&&(this.maxY=n)}}}postMapbounds(this.minX,this.minY,this.maxX,this.maxY),e("Map entities are loaded."),this.cycles=[n],this.postCycleAfterBake(0,n)},this.fillCycle=function(e){let i=this.cycles.length-1,n=JSON.parse(JSON.stringify(this.getCycleObject(i)));this.releaseCycleMemory(i),n.road={};let s=t[e];for(let t in s.Entities){let e,i,r=s.Entities[t],a=EntityHandler.getId(r);a in n.all?(Object.assign(n.all[a],new Entity(r)),e=n.all[a],i=EntityHandler.getId(e)):(e=new Entity(r),i=EntityHandler.getId(e),n.all[i]=e),EntityHandler.isHuman(e)?n.human[i]=e:EntityHandler.isBlockade(e)?n.blockade[i]=e:EntityHandler.isRoad(e)?n.road[i]=e:n.building[i]=e}this.cycles.push(n),this.postCycleAfterBake(e,n)},this.fillCycles=function(t,e){for(let e=1;e<t.length;e++)this.fillCycle(e);e("Game cycle entities are loaded.")},this.postCycleAfterBake=function(t,e){let i=new HistoryManager(this.baseHistorian.clone());i=this.fillHistoryWithCycleObject(i,e,t),postCycleData(t,i.historian)},this.fillHistoryWithCycleObject=function(t,e,i){return 0==i&&(this.fillHistoryWithObject(t,e.road),this.baseHistorian=t.historian.clone()),this.fillHistoryWithObject(t,e.building),this.fillHistoryWithObject(t,e.blockade),this.fillHistoryWithObject(t,e.human),this.fillHistoryWithObjectIcons(t,this.entitiesWithIcon),t},this.fillHistoryWithObject=function(t,e){for(let i in e){let n=e[i];this.positionMaker.reset(),this.positionMaker.addPolygon(mirrorYs(EntityHandler.getVertices(n)));let s=EntityHandler.getColor(n);t.setColor(s[0],s[1],s[2],1);let r=this.positionMaker.getPositionsList();t.submitVanilla(r)}return t},this.fillHistoryWithObjectIcons=function(t,e){for(const i of e){let e=EntityHandler.getIcon(i),n=EntityHandler.getCenterOfPolygon(i);t.setTextureSlut(textures[e]),t.setTextureResolution(28e3,28e3),t.setTextureTranslation(n[0]-7e3,7e3-n[1]);let s=n[0]-7e3,r=n[1]-7e3,a=n[0]+7e3,o=n[1]+7e3;t.submitVanilla([s,-r,s,-o,a,-r,a,-r,s,-o,a,-o])}return t},this.consturctor=function(t,e){this.positionMaker=new PositionMaker,this.baseHistorian=new Historian,this.entitiesWithIcon=[],this.createBaseCycle(t,e),this.fillCycles(t,e)},this.consturctor(t,e)}EntityHandler.humans=["Civilian","Ambulance team","Fire brigade","Police force"],EntityHandler.surfaces=["Road","Building","Refuge","Blockade","Hydrant","Gas Station","Ambulance centre","Fire station","Police office"],EntityHandler.buildings=["Building","Refuge","Gas Station","Ambulance centre","Fire station","Police office"],EntityHandler.roads=["Road","Hydrant"],EntityHandler.blockades=["Blockade"],EntityHandler.getColor=function(t){return EntityColor.getColor(t)},EntityHandler.getType=function(t){return t.EntityName},EntityHandler.getHP=function(t){return t.HP},EntityHandler.getIcon=function(t){switch(this.getType(t)){case"Hydrant":return ICONS_HYDRANT;case"Police office":return"image/po.png";case"Ambulance centre":return"image/ac.png";case"Fire station":return"image/fs.png";case"Refuge":return ICONS_REFUGE;case"Gas Station":return"image/gs.png"}return!1},EntityHandler.isRoad=function(t){return this.roads.includes(this.getType(t))},EntityHandler.isHuman=function(t){return this.humans.includes(this.getType(t))},EntityHandler.isSurface=function(t){return this.surfaces.includes(this.getType(t))},EntityHandler.isBlockade=function(t){return this.blockades.includes(this.getType(t))},EntityHandler.isBuilding=function(t){return this.buildings.includes(this.getType(t))},EntityHandler.getId=function(t){return t.Id},EntityHandler.getCenterOfPolygon=function(t){let e=t.Apexes;if(e){let t=[0,0],i=e.length;for(let n=0;n<i;n++)t[n%2]+=e[n];return t[0]/=i/2,t[1]/=i/2,t}return!1},EntityHandler.getHumanVertices=function(t,e,i=1500,n=15){let s,r,a=2*Math.PI/n,o=[t+i*Math.cos(0),e+i*Math.sin(0)];for(let n=0;n<=2*Math.PI;n+=a)s=t+i*Math.cos(n),r=e+i*Math.sin(n),o.push(s,r);return o},EntityHandler.getVertices=function(t){if(this.isSurface(t))return t.Apexes;if(this.isHuman(t)){let e=t.Pos;return this.getHumanVertices(e[0],e[1])}return[]},module={},importScripts("../node_modules/earcut/src/earcut.js"),importScripts("../preview/CanvasDrawer.js");var textures,dataLoader={};function wl(t){console.log("WorkerLog: "+t)}function loadFunction(t,e=-1,i=!1){progressReport(t,e,i),wl(t)}function progressReport(t,e=-1,i=!1){postMessage({command:"progress_report",percent:e,text:t,end:i})}function postMapbounds(t,e,i,n){wl("map bounds sent"),postMessage({command:"map_bounds",minX:t,minY:e,maxX:i,maxY:n})}function postCycleData(t,e){wl("cycle "+t+" sent"),postMessage({command:"cycle_data",cycle:t,data:e.getDataCopy()})}function postInfo(t){wl("map info sent"),postMessage({command:"info",info:t})}function handleIncomingMassage(t){switch(t.data.command){case"load_data":textures=t.data.textures,dataLoader=new WorkerDataLoader(t.data.data,loadFunction)}}onmessage=t=>handleIncomingMassage(t);