/*!
 * RCRS Web Viewer v0.1.0
 * https://github.com/roborescue/rcrs-web-viewer
 * 
 * Released under the BSD-3-Clause license
 * https://opensource.org/licenses/BSD-3-Clause
 *
 * Date: 2020-09-07T12:35:11.528Z (Mon, 07 Sep 2020 12:35:11 GMT)
 */
const DRAW_BORDER_LINE=!0,DRAW_BORDER_LINE_WIDTH=50,COMMAND_EXTINGUISH_LINE_WIDTH=50,ENTITY_NAME_CIVILIAN="Civilian",ENTITY_NAME_AMBULANCE_TEAM="Ambulance team",ENTITY_NAME_FIRE_BRIGADE="Fire brigade",ENTITY_NAME_POLICE_FORCE="Police force",ENTITY_NAME_BLOCKADE="Blockade",ENTITY_NAME_HYDRANT="Hydrant",ENTITY_NAME_ROAD="Road",ENTITY_NAME_REFUGE="Refuge",ENTITY_NAME_BUILDING="Building",ENTITY_NAME_GAS_STATION="Gas Station",ENTITY_NAME_AMBULANCE_CENTRE="Ambulance centre",ENTITY_NAME_FIRE_STATION="Fire station",ENTITY_NAME_POLICE_OFFICE="Police office",ENTITY_ATTR_ID="Id",ENTITY_ATTR_ENTITY_NAME="EntityName",ENTITY_ATTR_HP="urn:rescuecore2.standard:property:hp",ENTITY_ATTR_FIERYNESS="urn:rescuecore2.standard:property:fieryness",ENTITY_ATTR_APEXES="urn:rescuecore2.standard:property:apexes",ENTITY_ATTR_POSITION="urn:rescuecore2.standard:property:position",COMMAND_EXTINGUISH="urn:rescuecore2.standard:message:extinguish",ICONS_POLICE_OFFICE="image/po.png",ICONS_AMBULANCE_CENTRE="image/ac.png",ICONS_FIRE_STATION="image/fs.png",ICONS_REFUGE="image/rf.png",ICONS_GAS_STATION="image/gs.png",ICONS_HYDRANT="image/hy.png",SETTING_ICON_RADIUS=7e3,WORKER_COMMAND_LOADDATA="load_data",WORKER_COMMAND_PROGRESSREPORT="progress_report",WORKER_COMMAND_MAPBOUNDS="map_bounds",WORKER_COMMAND_CYCLEDATA="cycle_data",WORKER_COMMAND_INFO="info",WORKER_COMMAND_BASEDATA="base_data",HUMAN_HP_MAX=1e4,HUMAN_HP_INJURED=7500,HUMAN_HP_CRITICAL=1e3,COLOR_HUMAN_TYPE_CIVILIAN=[0,1,0],COLOR_HUMAN_TYPE_FIRE_BRIGADE=[1,0,0],COLOR_HUMAN_TYPE_AMBULANCE_TEAM=[1,1,1],COLOR_HUMAN_TYPE_POLICE_FORCE=[0,0,1],COLOR_HUMAN_TYPE_DEAD=[0,0,0],COLOR_ROAD_DEFAULT=[.72,.72,.72],COLOR_BLOCKADE_DEFAULT=[0,0,0],COLOR_BORDER_DEFAULT=[0,0,0],COLOR_COMMAND_EXTINGUISH=[.2,.2,1],COLOR_BUILDING_FIERYNESS_UNBURNT=[.52,.52,.52],COLOR_BUILDING_FIERYNESS_HEATING=[.69,.69,.21],COLOR_BUILDING_FIERYNESS_BURNING=[.8,.47,.19],COLOR_BUILDING_FIERYNESS_INFERNO=[.62,.2,.2],COLOR_BUILDING_FIERYNESS_WATER_DAMAGE=[.19,.47,.51],COLOR_BUILDING_FIERYNESS_MINOR_DAMAGE=[.39,.54,.82],COLOR_BUILDING_FIERYNESS_MODERATE_DAMAGE=[.39,.27,.74],COLOR_BUILDING_FIERYNESS_SEVERE_DAMAGE=[.31,.23,.54],COLOR_BUILDING_FIERYNESS_BURNT_OUT=[0,0,0];function Entity(t){Object.assign(this,t),"Id"in t&&(this.Id=parseInt(t.Id)),"EntityName"in t&&(this.EntityName=t.EntityName.trim()),ENTITY_ATTR_HP in t&&(this[ENTITY_ATTR_HP]=parseInt(t[ENTITY_ATTR_HP])),ENTITY_ATTR_FIERYNESS in t&&(this[ENTITY_ATTR_FIERYNESS]=parseInt(t[ENTITY_ATTR_FIERYNESS]))}EntityColor={},EntityColor.getDarker=function(t){return[t[0]/2,t[1]/2,t[2]/2]},EntityColor.getBuildingColor=function(t){switch(t){case 0:return COLOR_BUILDING_FIERYNESS_UNBURNT;case 1:return COLOR_BUILDING_FIERYNESS_HEATING;case 2:return COLOR_BUILDING_FIERYNESS_BURNING;case 3:return COLOR_BUILDING_FIERYNESS_INFERNO;case 4:return COLOR_BUILDING_FIERYNESS_WATER_DAMAGE;case 5:return COLOR_BUILDING_FIERYNESS_MINOR_DAMAGE;case 6:return COLOR_BUILDING_FIERYNESS_MODERATE_DAMAGE;case 7:return COLOR_BUILDING_FIERYNESS_SEVERE_DAMAGE;case 8:return COLOR_BUILDING_FIERYNESS_BURNT_OUT}return COLOR_BUILDING_FIERYNESS_UNBURNT},EntityColor.getHumanColor=function(t,e){if(0==e)return COLOR_HUMAN_TYPE_DEAD;let i;switch(t){case"Civilian":i=COLOR_HUMAN_TYPE_CIVILIAN;break;case"Fire brigade":i=COLOR_HUMAN_TYPE_FIRE_BRIGADE;break;case"Ambulance team":i=COLOR_HUMAN_TYPE_AMBULANCE_TEAM;break;case"Police force":i=COLOR_HUMAN_TYPE_POLICE_FORCE}return e<1e3&&(i=this.getDarker(i)),e<7500&&(i=this.getDarker(i)),e<1e4&&(i=this.getDarker(i)),i},EntityColor.getColor=function(t){return EntityHandler.isRoad(t)?COLOR_ROAD_DEFAULT:EntityHandler.isBuilding(t)?this.getBuildingColor(t[ENTITY_ATTR_FIERYNESS]):EntityHandler.isBlockade(t)?COLOR_BLOCKADE_DEFAULT:EntityHandler.isHuman(t)?this.getHumanColor(EntityHandler.getType(t),EntityHandler.getHP(t)):[0,0,0]};var EntityHandler={};function getKeyFromColor(t){return t[0]+" "+t[1]+" "+t[2]+" 1"}function OrdinalHistorian(){let t=new Historian;return t.addKey(getKeyFromColor(COLOR_ROAD_DEFAULT)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_UNBURNT)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_HEATING)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_BURNING)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_INFERNO)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_WATER_DAMAGE)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_MINOR_DAMAGE)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_MODERATE_DAMAGE)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_SEVERE_DAMAGE)),t.addKey(getKeyFromColor(COLOR_BUILDING_FIERYNESS_BURNT_OUT)),t.addKey(getKeyFromColor(COLOR_BLOCKADE_DEFAULT)),t.addKey(getKeyFromColor(COLOR_BORDER_DEFAULT)),t.addKey(getKeyFromColor(COLOR_HUMAN_TYPE_DEAD)),t.addKey(getKeyFromColor(COLOR_HUMAN_TYPE_CIVILIAN)),t.addKey(getKeyFromColor(COLOR_HUMAN_TYPE_FIRE_BRIGADE)),t.addKey(getKeyFromColor(COLOR_HUMAN_TYPE_AMBULANCE_TEAM)),t.addKey(getKeyFromColor(COLOR_HUMAN_TYPE_POLICE_FORCE)),t}function mirrorYs(t){return t.map((t,e)=>t*(e%2==1?-1:1))}function WorkerDataLoader(t,e=(()=>{})){this.getCycleObject=function(t){return this.cycles[t]},this.getCyclesNumber=function(){return this.cycles.length},this.releaseCycleMemory=function(t){delete this.cycles[t]},this.getInfoObject=function(){return this.info},this.checkForIcon=function(t){EntityHandler.getIcon(t)&&this.entitiesWithIcon.push(t)},this.fillAndPostInfo=function(t,e){t[0].lastCycle=t.length-2,postInfo(t[0])},this.createBaseCycle=function(t,e){this.minX=Number.MAX_SAFE_INTEGER,this.minY=Number.MAX_SAFE_INTEGER,this.maxX=Number.MIN_SAFE_INTEGER,this.maxY=Number.MIN_SAFE_INTEGER;let i=t[1],n={all:{},building:{},road:{},blockade:{},human:{}};for(let t=0;t<i.Entities.length;t++){let e=new Entity(i.Entities[t]);this.checkForIcon(e);let r=EntityHandler.getId(e);if(n.all[r]=e,EntityHandler.isHuman(e)?n.human[r]=e:EntityHandler.isBlockade(e)?n.blockade[r]=e:EntityHandler.isRoad(e)?n.road[r]=e:n.building[r]=e,EntityHandler.isSurface(e)){let t=EntityHandler.getVertices(e);for(let e=0;e<t.length;e+=2){let i=t[e],n=t[e+1];i<this.minX&&(this.minX=i),n<this.minY&&(this.minY=n),i>this.maxX&&(this.maxX=i),n>this.maxY&&(this.maxY=n)}}}postMapbounds(this.minX,this.minY,this.maxX,this.maxY),e("Map entities are loaded."),this.cycles=[n],this.postCycleAfterBake(0,n,i.Info,i.Commands)},this.fillCycle=function(t,e){let i=this.cycles.length-1,n=JSON.parse(JSON.stringify(this.getCycleObject(i)));n.road={};let r=e[t+1];for(let t in r.Entities){let e,i,o=r.Entities[t],a=EntityHandler.getId(o);a in n.all?(Object.assign(n.all[a],new Entity(o)),e=n.all[a],i=EntityHandler.getId(e)):(e=new Entity(o),i=EntityHandler.getId(e),n.all[i]=e),EntityHandler.isHuman(e)?n.human[i]=e:EntityHandler.isBlockade(e)?n.blockade[i]=e:EntityHandler.isRoad(e)?n.road[i]=e:n.building[i]=e}this.cycles.push(n),this.postCycleAfterBake(t,n,r.Info,r.Commands)},this.fillCycles=function(t,e){for(let e=1;e<t.length-1;e++)this.fillCycle(e,t);e("Game cycle entities are loaded.")},this.postCycleAfterBake=function(t,e,i,n){let r=new HistoryManager([this.baseHistorian.clone()]);r=this.fillHistoryWithCycleObject(r,e,t),r=this.fillHistoryWithCycleCommands(r,n,e),postCycleData(t,r.getActiveHistorian(),i)},this.fillHistoryWithCycleCommands=function(t,e=[],i){for(const n of e)this.fillHistoryWithCycleCommand(t,n,i);return t},this.fillHistoryWithCycleCommand=function(t,e,i){switch(e.Name){case COMMAND_EXTINGUISH:let n=parseInt(e.AgentId),r=parseInt(e.Target),o=i.all[n][ENTITY_ATTR_POSITION],a=EntityHandler.getCenterOfPolygon(i.all[r]);t.setColor(COLOR_COMMAND_EXTINGUISH[0],COLOR_COMMAND_EXTINGUISH[1],COLOR_COMMAND_EXTINGUISH[2],1),this.positionMaker.reset(),this.positionMaker.addLine(o[0],-o[1],a[0],-a[1],50),t.submitVanilla(this.positionMaker.getPositionsList()),console.log("POS:",o)}},this.fillHistoryWithCycleObject=function(t,e,i){if(0==i){let t=new HistoryManager([OrdinalHistorian()]),i=[];this.createLinesList(e.road,i),this.createLinesList(e.building,i),this.fillHistoryWithObject(t,e.road),this.fillBorderLines(t,i),postBaseData(t.getActiveHistorian())}return this.fillHistoryWithObject(t,e.building),this.fillHistoryWithObject(t,e.blockade),this.fillHistoryWithObject(t,e.human),this.fillHistoryWithObjectIcons(t,this.entitiesWithIcon),t},this.fillHistoryWithObject=function(t,e){for(let i in e){let n=e[i];this.positionMaker.reset();let r=mirrorYs(EntityHandler.getVertices(n));this.positionMaker.addPolygon(r);let o=EntityHandler.getColor(n);t.setColor(o[0],o[1],o[2],1),t.submitVanilla(this.positionMaker.getPositionsList())}return t},this.fillHistoryWithObjectIcons=function(t,e){for(const i of e){let e=EntityHandler.getIcon(i),n=EntityHandler.getCenterOfPolygon(i);t.setTextureSlut(textures[e]),t.setTextureResolution(28e3,28e3),t.setTextureTranslation(n[0]-7e3,7e3-n[1]);let r=n[0]-7e3,o=n[1]-7e3,a=n[0]+7e3,s=n[1]+7e3;t.submitVanilla([r,-o,r,-s,a,-o,a,-o,r,-s,a,-s])}return t},this.createLinesList=function(t,e){for(let i in t){let n=t[i],r=mirrorYs(EntityHandler.getVertices(n));this.positionMaker.reset(),this.positionMaker.addClosedSequenceLine(r,50),Array.prototype.push.apply(e,this.positionMaker.getPositionsList())}},this.fillBorderLines=function(t,e){return t.setColor(COLOR_BORDER_DEFAULT[0],COLOR_BORDER_DEFAULT[1],COLOR_BORDER_DEFAULT[2],1),t.submitVanilla(e),t},this.consturctor=function(t,e){this.positionMaker=new PositionMaker,this.baseHistorian=OrdinalHistorian(),this.entitiesWithIcon=[],this.fillAndPostInfo(t,e),this.createBaseCycle(t,e),this.fillCycles(t,e,2)},this.consturctor(t,e)}EntityHandler.humans=["Civilian","Ambulance team","Fire brigade","Police force"],EntityHandler.surfaces=["Road","Building","Refuge","Blockade","Hydrant","Gas Station","Ambulance centre","Fire station","Police office"],EntityHandler.buildings=["Building","Refuge","Gas Station","Ambulance centre","Fire station","Police office"],EntityHandler.roads=["Road","Hydrant"],EntityHandler.blockades=["Blockade"],EntityHandler.getColor=function(t){return EntityColor.getColor(t)},EntityHandler.getType=function(t){return t.EntityName},EntityHandler.getHP=function(t){return t[ENTITY_ATTR_HP]},EntityHandler.getIcon=function(t){switch(this.getType(t)){case"Hydrant":return ICONS_HYDRANT;case"Police office":return"image/po.png";case"Ambulance centre":return"image/ac.png";case"Fire station":return"image/fs.png";case"Refuge":return ICONS_REFUGE;case"Gas Station":return"image/gs.png"}return!1},EntityHandler.isRoad=function(t){return this.roads.includes(this.getType(t))},EntityHandler.isHuman=function(t){return this.humans.includes(this.getType(t))},EntityHandler.isSurface=function(t){return this.surfaces.includes(this.getType(t))},EntityHandler.isBlockade=function(t){return this.blockades.includes(this.getType(t))},EntityHandler.isBuilding=function(t){return this.buildings.includes(this.getType(t))},EntityHandler.getId=function(t){return t.Id},EntityHandler.getCenterOfPolygon=function(t){let e=t[ENTITY_ATTR_APEXES];if(e){let t=[0,0],i=e.length;for(let n=0;n<i;n++)t[n%2]+=e[n];return t[0]/=i/2,t[1]/=i/2,t}return!1},EntityHandler.getHumanVertices=function(t,e,i=1500,n=15){let r,o,a=2*Math.PI/n,s=[t+i*Math.cos(0),e+i*Math.sin(0)];for(let n=0;n<=2*Math.PI;n+=a)r=t+i*Math.cos(n),o=e+i*Math.sin(n),s.push(r,o);return s},EntityHandler.getVertices=function(t){if(this.isSurface(t))return t[ENTITY_ATTR_APEXES];if(this.isHuman(t)){let e=t[ENTITY_ATTR_POSITION];return this.getHumanVertices(e[0],e[1])}return[]},module={},importScripts("../node_modules/earcut/src/earcut.js"),importScripts("../preview/CanvasDrawer.js");var textures,dataLoader={};function wl(t){console.log("WorkerLog: "+t)}function loadFunction(t,e=-1,i=!1){progressReport(t,e,i),wl(t)}function progressReport(t,e=-1,i=!1){postMessage({command:"progress_report",percent:e,text:t,end:i})}function postMapbounds(t,e,i,n){wl("map bounds sent"),postMessage({command:"map_bounds",minX:t,minY:e,maxX:i,maxY:n})}function postCycleData(t,e,i={}){wl("cycle "+t+" sent"),postMessage({command:"cycle_data",cycle:t,data:e.getDataCopy(),info:i})}function postBaseData(t){wl("Base data sent"),postMessage({command:"base_data",data:t.getDataCopy()})}function postInfo(t){wl("map info sent"),postMessage({command:"info",info:t})}function handleIncomingMassage(t){switch(t.data.command){case"load_data":textures=t.data.textures,dataLoader=new WorkerDataLoader(t.data.data,loadFunction)}}onmessage=t=>handleIncomingMassage(t);